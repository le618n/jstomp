// Authors & copyright (c) 2014: le618n(le618n@hotmail.com). MIT license.
// For stomp specification please visit http://stomp.github.io/stomp-specification-1.2.html
(function(n){n.jStomp=function(n,t){var f=jStomp.extends({"heart-beat":[3e5,3e5],protocol:["v12.stomp"],"accept-version":"1.2"},t||{}),u=new WebSocket(n,f.protocol),h={},l=0,o,c,i=function(n,t,i){c=Date.now();u.send(jStomp.packet(n,t||{},i))},a={connected:function(n){r("onconnected",n.frames);v(n.frames.headers)},message:function(n){r("onmessage",n);var t=h[n.frames.headers.subscription];typeof t=="function"&&t(n.frames)},receipt:function(n){r("onreceipt",n.frames)},error:function(n){r("onerror",n.frames)}},e={subscribe:function(n,t,r){return r=r||{},r.id||(r.id="id-"+l++),r.destination=n,h[r.id]=t,i("SUBSCRIBE",r),r.id},unsubscribe:function(n){delete h[n];i("UNSUBSCRIBE",{id:n})},begin:function(n){i("BEGIN",{transaction:n})},commit:function(n){i("COMMIT",{transaction:n})},abort:function(n){i("ABORT",{transaction:n})},ack:function(n,t,r){r=r||{};r["message-id"]=n;r.subscription=t;i("ACK",r)},nack:function(n,t,r){r=r||{};r["message-id"]=n;r.subscription=t;i("NACK",r)},send:function(n,t,r){t=t||{};t.destination=n;i("SEND",t,r?r:"")},disconnect:function(){i("DISCONNECT");y();r("ondisconnected")}},r=function(n){s("dispatch:"+n);typeof e[n]=="function"&&e[n](arguments)},v=function(n){var t=function(n,i){if(i>0&&Date.now()-o>2*i)s("lost connection: "+new Date(o));else if(n>0){var r=Date.now()-c;r<=n?setTimeout(function(){t(n,i)},n+r):(u.send(jStomp.EOL),s("outgoing heart-beats: "+new Date),setTimeout(function(){t(n,i)},n))}},l=n["heart-beat"].split(","),i=parseInt(l[0]),r=parseInt(l[1]),e=f["heart-beat"][0],h=f["heart-beat"][1];e===0||r===0?i===0||h===0||t(Math.max(i,h),e===0||r===0?0:Math.max(e,r)):t(Math.max(e,r),i===0||h===0?0:Math.max(i,h))},s=function(n){if(typeof e.onlog=="function")e.onlog(n)},y=function(){u.close();u.onclose=null};return function(){u.onopen=function(n){r("onwsopen",n);i("CONNECT",{"heart-beat":f["heart-beat"].join(","),"accept-version":f["accept-version"]})};u.onclose=function(n){r("onwsclose",n)};u.onerror=function(n){r("onwserror",n)};u.onmessage=function(n){r("onwsmessage",n);o=Date.now();n.data===jStomp.EOL?s("incoming heart-beats: "+new Date(o)):(n.frames=jStomp.unpack(n.data),a[n.frames.command.toLowerCase()](n))}}(),e};jStomp.EOL="\n";jStomp.NUL='\0';jStomp.extends=function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n};jStomp.packet=function(n,t,i){var r=[n],u,f;if(t)for(u in t)r.push(u+":"+t[u]);return i&&(f=encodeURIComponent(i).match(/%[89ABab]/g),r.push("content-length:"+(i.length+(f?f.length:0)))),r.push(jStomp.EOL+(i?i:null)),r.join(jStomp.EOL)+jStomp.NUL};jStomp.unpack=function(n){for(var t=n.indexOf(jStomp.EOL),e=n.length,f={command:n.substring(0,t),headers:{},body:""},r,i,u;0<t&&t<e;){if(r=n.indexOf(jStomp.EOL,++t),t<r){i=n.substring(t,r);u=i.indexOf(":");0<u&&(f.headers[i.substring(0,u)]=i.substring(++u,i.length));t=r;continue}f.body=n.substring(++t,--e);break}return f}})(window);